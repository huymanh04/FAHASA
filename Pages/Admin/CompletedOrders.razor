@page "/admin/completed-orders"
@using SportsStore.Models
@using Microsoft.EntityFrameworkCore
@inherits OwningComponentBase<IOrderRepository>
@layout AdminLayout

<div class="page-card">
    <div class="orders-header">
        <h2 class="page-title">
            <i class="fas fa-check-circle"></i>
            <span>Đơn hàng thành công</span>
        </h2>
        <div class="filter-row">
            <div class="filter-group">
                <label for="fromDate">Từ ngày</label>
                <input type="date" id="fromDate" @bind="fromDate" />
            </div>
            <div class="filter-group">
                <label for="toDate">Đến ngày</label>
                <input type="date" id="toDate" @bind="toDate" />
            </div>
            <div class="filter-group" style="align-self:end;">
                <button class="refresh-btn" @onclick="LoadData"><i class="fas fa-filter"></i><span>Lọc</span></button>
            </div>
        </div>
    </div>

    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Mã đơn</th>
                <th>Ngày đặt</th>
                <th>Khách hàng</th>
                <th>Số mặt hàng</th>
                <th>Tổng số lượng</th>
                <th>Tổng tiền</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        @if (DeliveredOrders.Any())
        {
            foreach (var o in DeliveredOrders)
            {
                var totalItems = o.Lines.Count;
                var totalQty = o.Lines.Sum(l => l.Quantity);
                var totalMoney = o.TotalAmount > 0 ? o.TotalAmount : o.Lines.Sum(l => l.Product.Price * l.Quantity);
                <tr>
                    <td>#@o.OrderID</td>
                    <td>@o.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@o.Name</td>
                    <td>@totalItems</td>
                    <td>@totalQty</td>
                    <td>@string.Format("{0:N0} đ", totalMoney)</td>
                    <td>
                        <a href="/Order/Details/@o.OrderID" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> Chi tiết
                        </a>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr><td colspan="7" class="text-center text-muted">Không có đơn hàng nào trong phạm vi lọc</td></tr>
        }
        </tbody>
    </table>

    <div class="mt-3">
        <strong>Tổng doanh thu hiển thị:</strong>
        @string.Format("{0:N0} đ", DisplayRevenue)
    </div>
</div>

<style>
    .orders-header { display:flex; justify-content: space-between; align-items:flex-end; flex-wrap:wrap; gap:20px; margin-bottom:25px; }
    .page-title { font-size:1.8rem; font-weight:700; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; display:flex; gap:10px; align-items:center; }
    .filter-row { display:flex; gap:15px; flex-wrap:wrap; }
    .filter-group label { font-weight:600; margin-bottom:6px; }
    .filter-group input { padding:8px 12px; border:2px solid #e0e0e0; border-radius:8px; }
    .filter-group input:focus { outline:none; border-color:#667eea; }
    .refresh-btn { background:linear-gradient(135deg,#4facfe,#00f2fe); color:#fff; border:none; padding:10px 20px; border-radius:10px; display:inline-flex; align-items:center; gap:8px; font-weight:600; }
    .refresh-btn:hover { filter:brightness(1.05); }
    table thead th { background:#f8f9fa; }
</style>

@code {
    public IOrderRepository Repository => Service;

    private DateTime fromDate = DateTime.Today.AddDays(-7);
    private DateTime toDate = DateTime.Today;

    public List<Order> DeliveredOrders { get; set; } = new();
    public decimal DisplayRevenue { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        DeliveredOrders = await Repository.Orders
            .Where(o => o.Status == OrderStatus.DaNhanHang && o.OrderDate.Date >= fromDate.Date && o.OrderDate.Date <= toDate.Date)
            .Include(o => o.Lines).ThenInclude(l => l.Product)
            .OrderByDescending(o => o.OrderDate)
            .ToListAsync();
        DisplayRevenue = DeliveredOrders.Sum(o => o.TotalAmount > 0 ? o.TotalAmount : o.Lines.Sum(l => l.Product.Price * l.Quantity));
    }
}
