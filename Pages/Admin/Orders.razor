@page "/admin/orders"
@using SportsStore.Models
@using Microsoft.EntityFrameworkCore
@using SportsStore.Services
@inherits OwningComponentBase<IOrderRepository>
@layout AdminLayout
@inject INotificationService NotificationService

<style>
    .orders-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .refresh-btn {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }

    .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
    }
</style>

<div class="page-card">
    <div class="orders-header">
        <h2 class="page-title">
            <i class="fas fa-receipt"></i>
            <span>Quản lý đơn hàng</span>
        </h2>
        <button class="refresh-btn" @onclick="UpdateData">
            <i class="fas fa-sync-alt"></i>
            <span>Làm mới danh sách</span>
        </button>
    </div>

<!-- Bảng theo từng trạng thái -->
<OrderTable TableTitle="Chờ xác nhận"
            Orders="PendingOrders"
            ButtonLabel="Chuyển sang Chờ giao hàng"
            OrderSelected="orderId => UpdateOrderStatus(orderId, OrderStatus.ChoGiaoHang)"
            ShowCancelButton="true"
            CancelOrder="orderId => OpenCancelModal(orderId)" />

<OrderTable TableTitle="Chờ giao hàng"
            Orders="WaitingOrders"
            ButtonLabel="Chuyển sang Đang vận chuyển"
            OrderSelected="orderId => UpdateOrderStatus(orderId, OrderStatus.DangVanChuyen)"
            ShowCancelButton="true"
            CancelOrder="orderId => OpenCancelModal(orderId)" />

<OrderTable TableTitle="Đang vận chuyển"
            Orders="DeliveringOrders"
            ButtonLabel="Chuyển sang Đã nhận hàng"
            OrderSelected="orderId => UpdateOrderStatus(orderId, OrderStatus.DaNhanHang)"
            ShowCancelButton="true"
            CancelOrder="orderId => OpenCancelModal(orderId)" />

<OrderTable TableTitle="Yêu cầu hoàn tiền"
            Orders="RefundRequestedOrders"
            ButtonLabel="Hoàn tiền thành công"
            OrderSelected="orderId => UpdateOrderStatus(orderId, OrderStatus.HoanTienThanhCong)" />

<OrderTable TableTitle="Đơn đã nhận"
            Orders="CompletedOrders"
            ButtonLabel="Không thao tác"
            OrderSelected="@(id => Task.CompletedTask)" />

<OrderTable TableTitle="Đơn đã hủy"
            Orders="CancelledOrders"
            ButtonLabel="Không thao tác"
            OrderSelected="@(id => Task.CompletedTask)" />
</div>

@if (showCancelModal)
{
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:2000;">
        <div style="background:#fff;width:420px;max-width:95%;padding:25px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.3);">
            <h5 style="font-weight:700;display:flex;align-items:center;gap:8px;margin-bottom:15px;">
                <i class="fas fa-ban text-danger"></i> Hủy đơn hàng #@cancelOrderId
            </h5>
            <div class="mb-3">
                <label class="form-label fw-semibold">Lý do hủy (bắt buộc)</label>
                <textarea class="form-control" rows="4" @bind="cancelReason" placeholder="Nhập lý do hủy đơn..."></textarea>
            </div>
            <div class="d-flex gap-2 justify-content-end">
                <button class="btn btn-secondary" @onclick="CloseCancelModal"><i class="fas fa-times"></i> Đóng</button>
                <button class="btn btn-danger" disabled="@(string.IsNullOrWhiteSpace(cancelReason))" @onclick="ConfirmCancelAsync">
                    <i class="fas fa-check"></i> Xác nhận hủy
                </button>
            </div>
        </div>
    </div>
}

@code {
    public IOrderRepository Repository => Service;

    public IEnumerable<Order> AllOrders { get; set; } = Enumerable.Empty<Order>();

    public IEnumerable<Order> PendingOrders { get; set; } = Enumerable.Empty<Order>();
    public IEnumerable<Order> WaitingOrders { get; set; } = Enumerable.Empty<Order>();
    public IEnumerable<Order> DeliveringOrders { get; set; } = Enumerable.Empty<Order>();
    public IEnumerable<Order> CompletedOrders { get; set; } = Enumerable.Empty<Order>();
    public IEnumerable<Order> CancelledOrders { get; set; } = Enumerable.Empty<Order>();
    public IEnumerable<Order> RefundRequestedOrders { get; set; } = Enumerable.Empty<Order>();

    protected override async Task OnInitializedAsync()
    {
        await UpdateData();
    }

    public async Task UpdateData()
    {
        AllOrders = await Repository.Orders
            .Include(o => o.Lines)
            .ThenInclude(l => l.Product)
            .AsNoTracking()
            .ToListAsync();

        PendingOrders = AllOrders.Where(o => o.Status == OrderStatus.ChoXacNhan).OrderByDescending(o => o.OrderID);
        WaitingOrders = AllOrders.Where(o => o.Status == OrderStatus.ChoGiaoHang).OrderByDescending(o => o.OrderID);
        DeliveringOrders = AllOrders.Where(o => o.Status == OrderStatus.DangVanChuyen).OrderByDescending(o => o.OrderID);
        CompletedOrders = AllOrders.Where(o => o.Status == OrderStatus.DaNhanHang).OrderByDescending(o => o.OrderID);
        CancelledOrders = AllOrders.Where(o => o.Status == OrderStatus.DaHuy).OrderByDescending(o => o.OrderID);
        RefundRequestedOrders = AllOrders.Where(o => o.Status == OrderStatus.YeuCauHoanTien).OrderByDescending(o => o.OrderID);
    }

    public async Task UpdateOrderStatus(int id, OrderStatus newStatus)
    {
        var order = await Repository.Orders.FirstOrDefaultAsync(o => o.OrderID == id);
        if (order != null)
        {
            order.Status = newStatus;
            // Đồng bộ Shipped cho logic cũ (review, hiển thị)
            order.Shipped = newStatus == OrderStatus.DaNhanHang;
            Repository.SaveOrder(order);
            
            // Gửi thông báo cho khách hàng
            if (!string.IsNullOrEmpty(order.UserId))
            {
                var message = GetStatusMessage(newStatus, order.OrderID);
                var statusKey = GetStatusKey(newStatus);
                await NotificationService.CreateOrderNotificationAsync(
                    order.UserId, 
                    order.OrderID, 
                    statusKey, 
                    message
                );
            }
            
            await UpdateData();
        }
    }

    // ===== Hủy đơn hàng (Admin) =====
    private bool showCancelModal = false;
    private int cancelOrderId;
    private string? cancelReason;

    private void OpenCancelModal(int orderId)
    {
        cancelOrderId = orderId;
        cancelReason = string.Empty;
        showCancelModal = true;
    }

    private void CloseCancelModal()
    {
        showCancelModal = false;
        cancelReason = string.Empty;
    }

    private async Task ConfirmCancelAsync()
    {
        var order = await Repository.Orders.FirstOrDefaultAsync(o => o.OrderID == cancelOrderId);
        if (order != null && order.Status != OrderStatus.DaHuy && order.Status != OrderStatus.DaNhanHang)
        {
            order.Status = OrderStatus.DaHuy;
            order.CancellationReason = cancelReason;
            order.Shipped = false; // đảm bảo không đánh dấu đã giao
            Repository.SaveOrder(order);

            if (!string.IsNullOrEmpty(order.UserId))
            {
                var message = $"Đơn hàng #{order.OrderID} đã bị hủy. Lý do: {cancelReason}";
                await NotificationService.CreateOrderNotificationAsync(order.UserId, order.OrderID, "Cancelled", message);
            }
            await UpdateData();
        }
        CloseCancelModal();
    }

    private string GetStatusKey(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.ChoGiaoHang => "Approved",
            OrderStatus.DangVanChuyen => "Shipping",
            OrderStatus.DaNhanHang => "Delivered",
            OrderStatus.DaHuy => "Cancelled",
            _ => "Updated"
        };
    }

    private string GetStatusMessage(OrderStatus status, int orderId)
    {
        return status switch
        {
            OrderStatus.ChoGiaoHang => $"Đơn hàng #{orderId} của bạn đã được xác nhận và đang chuẩn bị giao hàng.",
            OrderStatus.DangVanChuyen => $"Đơn hàng #{orderId} đang được vận chuyển đến bạn. Vui lòng chú ý điện thoại.",
            OrderStatus.DaNhanHang => $"Đơn hàng #{orderId} đã được giao thành công. Cảm ơn bạn đã mua hàng!",
            OrderStatus.DaHuy => $"Đơn hàng #{orderId} đã bị hủy.",
            OrderStatus.HoanTienThanhCong => $"Đơn hàng #{orderId} đã được hoàn tiền thành công.",
            _ => $"Đơn hàng #{orderId} đã được cập nhật trạng thái."
        };
    }
}
